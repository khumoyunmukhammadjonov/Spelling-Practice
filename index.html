<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spelling Practice</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      width: 90%;
      max-width: 800px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      position: relative;
    }
    
    @media (max-width: 768px) {
      .container {
        width: 95%;
        padding: 20px;
      }
      
      .title {
        font-size: 24px;
      }
      
      .stat-value {
        font-size: 18px;
      }
      
      .letter-display {
        font-size: 100px;
        height: 120px;
      }
      
      .countdown {
        font-size: 80px;
      }
      
      .level-number {
        font-size: 36px;
      }
      
      .level-name {
        font-size: 16px;
      }
      
      .name-input {
        font-size: 20px;
        padding: 12px 20px;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }
      
      .stats {
        gap: 15px;
      }
      
      .level-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .title {
      font-size: 32px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stats {
      display: flex;
      gap: 20px;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .start-screen {
      text-align: center;
      padding: 40px 0;
    }
    
    .subtitle {
      font-size: 18px;
      color: #666;
      margin-bottom: 40px;
    }
    
    .level-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .level-card {
      background: white;
      border: 3px solid #e0e0e0;
      border-radius: 15px;
      padding: 30px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .level-card:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
    }
    
    .level-number {
      font-size: 48px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .level-name {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .level-desc {
      font-size: 14px;
      color: #999;
    }
    
    .game-screen {
      display: none;
      text-align: center;
      padding: 40px 0;
      min-height: 500px;
    }
    
    .game-screen.expert-mode {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .countdown {
      font-size: 120px;
      font-weight: bold;
      color: #667eea;
      animation: pulse 1s ease-in-out;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .letter-display {
      font-size: 150px;
      font-weight: bold;
      color: #333;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      transition: color 0.3s ease;
    }
    
    /* New Arial override for levels 1 and 2 */
    .font-arial {
      font-family: Arial, Helvetica, sans-serif !important;
    }
    
    .letter-display.hidden {
      visibility: hidden;
    }
    
    .letter-display.hide-completely {
      display: none;
    }
    
    .letter-display.correct {
      color: #10b981;
    }
    
    .letter-display.incorrect {
      color: #ef4444;
    }
    
    .instruction {
      font-size: 20px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .name-input {
      font-size: 28px;
      padding: 15px 25px;
      border: 3px solid #e0e0e0;
      border-radius: 10px;
      text-align: center;
      width: 100%;
      max-width: 400px;
      outline: none;
      transition: all 0.3s ease;
      margin: 0 auto;
      display: block;
    }
    
    .name-input:focus {
      border-color: #667eea;
    }
    
    .name-input.correct {
      border-color: #10b981;
      color: #10b981;
    }
    
    .name-input.incorrect {
      border-color: #ef4444;
      color: #ef4444;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 10px;
    }
    
    .progress-text {
      font-size: 16px;
      color: #666;
      margin-top: 5px;
    }
    
    .result-screen {
      display: none;
      text-align: center;
      padding: 40px 0;
    }
    
    .result-title {
      font-size: 48px;
      font-weight: bold;
      color: #333;
      margin-bottom: 30px;
    }
    
    .result-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .result-stat {
      background: #f3f4f6;
      padding: 20px;
      border-radius: 10px;
    }
    
    .result-stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
    }
    
    .result-stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .btn {
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-top: 20px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    .loading {
      display: none;
      color: #666;
      margin-top: 20px;
    }
    
    .timer {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
    }
    
    .timer.warning {
      color: #ef4444;
      animation: pulse 1s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Spelling Practice</div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Time</div>
          <div class="stat-value timer" id="timer">5:00</div>
        </div>
        <div class="stat" id="accuracyStat" style="display: none;">
          <div class="stat-label">Accuracy</div>
          <div class="stat-value" id="accuracy">100%</div>
        </div>
      </div>
    </div>
    
    <div class="start-screen" id="startScreen">
      <div class="subtitle">Choose your challenge level</div>
      <div class="level-grid">
        <div class="level-card" onclick="startGame(1)">
          <div class="level-number">1</div>
          <div class="level-name">Beginner</div>
          <div class="level-desc">Visual letters</div>
        </div>
        <div class="level-card" onclick="startGame(2)">
          <div class="level-number">2</div>
          <div class="level-name">Advanced</div>
          <div class="level-desc">Audio only</div>
        </div>
        <div class="level-card" onclick="startGame(3)">
          <div class="level-number">3</div>
          <div class="level-name">Expert</div>
          <div class="level-desc">Spell names</div>
        </div>
      </div>
      <div class="loading" id="loading">‚è≥ Loading names...</div>
    </div>
    
    <div class="game-screen" id="gameScreen">
      <div class="instruction" id="instruction"></div>
      <div class="letter-display" id="letterDisplay"></div>
      <input type="text" class="name-input" id="nameInput" placeholder="Type the name..." autocomplete="off" style="display: none;">
      <button class="btn btn-secondary" onclick="quitGame()">Quit</button>
    </div>
    
    <div class="result-screen" id="resultScreen">
      <div class="result-title">Time's Up! üéâ</div>
      <div class="result-stats">
        <div class="result-stat">
          <div class="result-stat-value" id="finalAccuracy">0%</div>
          <div class="result-stat-label">Accuracy</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="finalCorrect">0</div>
          <div class="result-stat-label">Correct</div>
        </div>
        <div class="result-stat">
          <div class="result-stat-value" id="finalMistakes">0</div>
          <div class="result-stat-label">Mistakes</div>
        </div>
        <div class="result-stat" id="finalNamesDiv" style="display: none;">
          <div class="result-stat-value" id="finalNames">0</div>
          <div class="result-stat-label">Names Completed</div>
        </div>
      </div>
      <button class="btn" onclick="resetGame()">Play Again</button>
    </div>
  </div>

  <audio id="errorSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>
  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_success_fanfare.ogg"></audio>

  <script>
    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    let names = [];
    let namesLoaded = false;
    let voicesLoaded = false;
    
    let gameActive = false;
    let currentLevel = 1;
    let timeLeft = 300;
    let timerInterval = null;
    let correctCount = 0;
    let mistakeCount = 0;
    let namesCompleted = 0;
    let acceptingInput = true;
    
    let currentLetter = null;
    let currentName = null;
    let spellingIndex = 0;
    let spellingTimer = null;
    let letterFrequencies = {};
    let nameFrequencies = {};
    
    const elements = {
      startScreen: document.getElementById('startScreen'),
      gameScreen: document.getElementById('gameScreen'),
      resultScreen: document.getElementById('resultScreen'),
      letterDisplay: document.getElementById('letterDisplay'),
      instruction: document.getElementById('instruction'),
      nameInput: document.getElementById('nameInput'),
      timer: document.getElementById('timer'),
      accuracy: document.getElementById('accuracy'),
      accuracyStat: document.getElementById('accuracyStat'),
      loading: document.getElementById('loading'),
      errorSound: document.getElementById('errorSound'),
      successSound: document.getElementById('successSound')
    };
    
    async function fetchNames() {
      elements.loading.style.display = 'block';
      try {
        const response = await fetch('https://randomuser.me/api/?results=100&inc=name&nat=us,gb');
        const data = await response.json();
        names = data.results
          .map(p => p.name.first)
          .filter(n => /^[a-zA-Z]+$/.test(n))
          .filter((n, i, arr) => arr.indexOf(n) === i);
        
        if (names.length < 20) {
          names = [...new Set([...names, "Alice", "Bob", "Charlie", "David", "Emma", "Frank", "Grace", "Henry", "Jack", "Ruby"])];
        }
      } catch (error) {
        names = ["Alice", "Bob", "Charlie", "David", "Emma", "Frank", "Grace", "Henry", "Jack", "Ruby"];
      }
      namesLoaded = true;
      checkReady();
    }
    
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0 && !voicesLoaded) {
        voicesLoaded = true;
        checkReady();
      }
    }
    
    function checkReady() {
      if (namesLoaded && voicesLoaded) {
        elements.loading.style.display = 'none';
      }
    }
    
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();
    fetchNames();
    
    function speak(text) {
      return new Promise((resolve) => {
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        utterance.lang = "en-GB";
        utterance.rate = currentLevel === 3 ? 1.0 : 0.85;
        utterance.pitch = 1;
        
        const voice = voices.find(v => v.name.includes("Google UK English")) || 
                      voices.find(v => v.name.includes("British")) ||
                      voices.find(v => v.name.includes("Daniel")) || 
                      voices.find(v => v.name.includes("Hazel")) ||  
                      voices.find(v => v.lang === "en-GB") || 
                      voices.find(v => v.lang === "en-UK") ||
                      voices.find(v => v.lang.startsWith("en"));
        if (voice) utterance.voice = voice;
        utterance.onend = () => resolve();
        utterance.onerror = () => resolve();
        speechSynthesis.speak(utterance);
      });
    }
    
    function cleanup() {
      gameActive = false;
      acceptingInput = false;
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (spellingTimer) {
        clearTimeout(spellingTimer);
        spellingTimer = null;
      }
      speechSynthesis.cancel();
      
      elements.errorSound.pause();
      elements.errorSound.currentTime = 0;
      elements.successSound.pause();
      elements.successSound.currentTime = 0;
    }
    
    async function startGame(level) {
      if (level === 3 && !namesLoaded) return;
      
      cleanup();
      await new Promise(r => setTimeout(r, 100));
      
      currentLevel = level;
      elements.startScreen.style.display = 'none';
      elements.gameScreen.style.display = level === 3 ? 'flex' : 'block';
      
      // APPLY ARIAL CLASS FOR LEVELS 1 AND 2
      if (level === 1 || level === 2) {
        elements.letterDisplay.classList.add('font-arial');
      } else {
        elements.letterDisplay.classList.remove('font-arial');
      }

      if (level === 3) {
        elements.gameScreen.classList.add('expert-mode');
      } else {
        elements.gameScreen.classList.remove('expert-mode');
      }
      elements.accuracyStat.style.display = 'block';
      elements.resultScreen.style.display = 'none';
      
      for (let i = 3; i > 0; i--) {
        elements.letterDisplay.textContent = i;
        // Keep countdown logic but maintain arial if applicable
        elements.letterDisplay.className = 'letter-display countdown' + (level < 3 ? ' font-arial' : '');
        elements.letterDisplay.style.display = 'flex';
        await new Promise(r => setTimeout(r, 1000));
      }
      
      elements.letterDisplay.textContent = 'GO!';
      await new Promise(r => setTimeout(r, 500));
      
      elements.letterDisplay.textContent = '';
      
      gameActive = true;
      acceptingInput = true;
      timeLeft = 300;
      correctCount = 0;
      mistakeCount = 0;
      namesCompleted = 0;
      
      if (level === 3) {
        elements.instruction.textContent = 'Type the name as it\'s spelled out';
        elements.instruction.style.display = 'block';
        elements.nameInput.style.display = 'block';
        elements.letterDisplay.style.display = 'none';
        nameFrequencies = {};
        names.forEach(n => nameFrequencies[n] = 0);
        elements.nameInput.value = '';
        elements.nameInput.className = 'name-input';
        elements.nameInput.focus();
        await new Promise(r => setTimeout(r, 500));
        generateNextName();
      } else {
        elements.instruction.textContent = level === 1 ? 'Type the letter you see' : 'Type the letter you hear';
        elements.instruction.style.display = 'block';
        elements.nameInput.style.display = 'none';
        elements.letterDisplay.style.display = 'flex';
        elements.letterDisplay.className = 'letter-display font-arial';
        letterFrequencies = {};
        LETTERS.forEach(l => letterFrequencies[l] = 0);
        generateNextLetter();
      }
      
      elements.accuracy.textContent = '100%';
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        if (!gameActive) return;
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) endGame();
      }, 1000);
    }
    
    function generateNextLetter() {
      if (!gameActive) return;
      const minFreq = Math.min(...Object.values(letterFrequencies));
      const candidates = LETTERS.filter(l => letterFrequencies[l] === minFreq);
      currentLetter = candidates[Math.floor(Math.random() * candidates.length)];
      letterFrequencies[currentLetter]++;
      
      if (currentLevel === 1) {
        elements.letterDisplay.textContent = currentLetter;
        elements.letterDisplay.className = 'letter-display font-arial';
      } else if (currentLevel === 2) {
        elements.letterDisplay.textContent = '';
        elements.letterDisplay.className = 'letter-display font-arial hidden';
      }
      
      speak(currentLetter);
    }
    
    function generateNextName() {
      if (!gameActive) return;
      if (spellingTimer) {
        clearTimeout(spellingTimer);
        spellingTimer = null;
      }
      speechSynthesis.cancel();
      isSpelling = false;
      
      const minFreq = Math.min(...Object.values(nameFrequencies));
      const candidates = names.filter(n => nameFrequencies[n] === minFreq);
      currentName = candidates[Math.floor(Math.random() * candidates.length)];
      nameFrequencies[currentName]++;
      spellingIndex = 0;
      
      setTimeout(() => {
        if (gameActive && currentLevel === 3) {
          isSpelling = true;
          spellOutName();
        }
      }, 100);
    }
    
    let isSpelling = false;
    
    async function spellOutName() {
      if (!gameActive || currentLevel !== 3 || spellingIndex >= currentName.length || !isSpelling) return;
      
      const char = currentName[spellingIndex].toUpperCase();
      let count = 1;
      for (let i = spellingIndex + 1; i < currentName.length; i++) {
        if (currentName[i].toUpperCase() === char) count++;
        else break;
      }
      
      if (count > 1) {
        const words = ['', '', 'double', 'triple', 'quadruple'];
        const text = count <= 4 ? `${words[count]} ${char}` : `${char} ${count} times`;
        await speak(text);
        if (!gameActive || currentLevel !== 3 || !isSpelling) return;
        spellingIndex += count;
        await new Promise(r => setTimeout(r, 150));
      } else {
        await speak(char);
        if (!gameActive || currentLevel !== 3 || !isSpelling) return;
        spellingIndex++;
        await new Promise(r => setTimeout(r, 150));
      }
      
      if (gameActive && currentLevel === 3 && spellingIndex < currentName.length && isSpelling) {
        spellOutName();
      }
    }
    
    function updateTimerDisplay() {
      const mins = Math.floor(timeLeft / 60);
      const secs = timeLeft % 60;
      elements.timer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      elements.timer.className = timeLeft <= 30 ? 'timer warning' : 'timer';
    }
    
    function updateAccuracy() {
      const total = correctCount + mistakeCount;
      const acc = total > 0 ? Math.round((correctCount / total) * 100) : 100;
      elements.accuracy.textContent = acc + '%';
    }
    
    document.addEventListener('keydown', (e) => {
      if (!gameActive || !acceptingInput || currentLevel === 3) return;
      const key = e.key.toUpperCase();
      if (!/^[A-Z]$/.test(key)) return;
      
      acceptingInput = false;
      elements.letterDisplay.textContent = key;
      elements.letterDisplay.style.display = 'flex';
      
      if (key === currentLetter) {
        correctCount++;
        elements.letterDisplay.className = 'letter-display font-arial correct';
        updateAccuracy();
        setTimeout(() => {
          if (!gameActive) return;
          generateNextLetter();
          acceptingInput = true;
        }, 700);
      } else {
        mistakeCount++;
        elements.letterDisplay.className = 'letter-display font-arial incorrect';
        elements.errorSound.currentTime = 0;
        elements.errorSound.play();
        updateAccuracy();
        setTimeout(() => {
          if (!gameActive) return;
          if (currentLevel === 2) {
            elements.letterDisplay.textContent = '';
            elements.letterDisplay.className = 'letter-display font-arial hidden';
          } else {
            elements.letterDisplay.className = 'letter-display font-arial';
          }
          speak(currentLetter);
          acceptingInput = true;
        }, 700);
      }
    });
    
    elements.nameInput.addEventListener('keydown', async (e) => {
      if (!gameActive || currentLevel !== 3 || e.key !== 'Enter') return;
      e.preventDefault();
      
      isSpelling = false;
      speechSynthesis.cancel();
      if (spellingTimer) {
        clearTimeout(spellingTimer);
        spellingTimer = null;
      }
      
      const input = elements.nameInput.value.trim();
      
      if (input.toLowerCase() === currentName.toLowerCase()) {
        correctCount++;
        namesCompleted++;
        elements.nameInput.className = 'name-input correct';
        elements.successSound.currentTime = 0;
        elements.successSound.play();
        updateAccuracy();
        setTimeout(() => {
          if (!gameActive) return;
          elements.nameInput.value = '';
          elements.nameInput.className = 'name-input';
          generateNextName();
        }, 1200);
      } else {
        mistakeCount++;
        elements.nameInput.className = 'name-input incorrect';
        elements.errorSound.currentTime = 0;
        elements.errorSound.play();
        updateAccuracy();
        
        await new Promise(resolve => {
          elements.errorSound.onended = resolve;
          setTimeout(resolve, 1500);
        });
        
        if (!gameActive || currentLevel !== 3) return;
        elements.nameInput.value = '';
        elements.nameInput.className = 'name-input';
        spellingIndex = 0;
        isSpelling = true;
        spellOutName();
      }
    });
    
    elements.nameInput.addEventListener('click', () => {
      if (gameActive && currentLevel === 3) {
        isSpelling = false;
        if (spellingTimer) {
          clearTimeout(spellingTimer);
          spellingTimer = null;
        }
        speechSynthesis.cancel();
        spellingIndex = 0;
        isSpelling = true;
        spellOutName();
      }
    });
    
    function endGame() {
      cleanup();
      const total = correctCount + mistakeCount;
      const acc = total > 0 ? Math.round((correctCount / total) * 100) : 0;
      document.getElementById('finalAccuracy').textContent = acc + '%';
      document.getElementById('finalCorrect').textContent = correctCount;
      document.getElementById('finalMistakes').textContent = mistakeCount;
      
      if (currentLevel === 3) {
        document.getElementById('finalNamesDiv').style.display = 'block';
        document.getElementById('finalNames').textContent = namesCompleted;
      } else {
        document.getElementById('finalNamesDiv').style.display = 'none';
      }
      
      elements.gameScreen.style.display = 'none';
      elements.resultScreen.style.display = 'block';
    }
    
    function quitGame() {
      cleanup();
      location.reload();
    }
    
    function resetGame() {
      cleanup();
      location.reload();
    }
  </script>
</body>
</html>
